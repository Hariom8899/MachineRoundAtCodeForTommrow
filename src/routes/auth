const express = require('express');
const bcrypt = require('bcrypt');
const User = require('../models/user');
const jwt = require('jsonwebtoken');
const validator = require('validator');
const { validateSingUpData } = require('../utils/validation');
const authRouter = express.Router();

authRouter.post('/signUp', async (req, res) => {
  try{
    validateSingUpData(req);
    const {firstName, lastName, email, password } = req.body;
    const hashPassword = await bcrypt.hash(password, 10);
    const user = new User({
        firstName,
        lastName,
        email,
        password:hashPassword,
    })

    await user.save();
    res.send('SignUp Success');
  }
  catch(err){
    res.status(400).send('Erro Occured in Signup ' + err.message);
  }
})

authRouter.post('/login', async (req, res) => {
   try{
    const { email, password } = req.body;
    const user = await User.find({email:email});
    if(!user){
        throw new Error('Please Login No Such Email Exists');
    }
    const isPasswordCorrect = await bcrypt.compare(password, user.password);

    if(isPasswordCorrect){
    const token = await jwt.sign({_id:user._id,}, "secretKey", {expiresIn: "1d"});
    res.cookie("token", token);
    res.send('Login Success');
    }
    else{
        throw new Error('Incorrect Password');
    }

  }
  catch(err){
    res.status(400).send('Error Occured in Login ' + err.message);
  }
})

module.exports = authRouter;